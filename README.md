# Скрипт синхронизации заказов ABCP и Versta24

Этот Python-скрипт синхронизирует статусы заказов между платформами ABCP и Versta24, получая заказы из обеих систем, сопоставляя их по идентификаторам заказов и обновляя статусы заказов в ABCP на основе комбинации `masterStatus` и `subStatus` из Versta24.

## Функциональность

- Получение заказов из API ABCP и Versta24.
- Сопоставление заказов по `customerOrderId` (Versta24) и `number` (ABCP).
- Точное сопоставление статусов на основе `masterStatus` и `subStatus` из Versta24 с соответствующими идентификаторами статусов ABCP.
- Обновление позиций заказов в ABCP новыми статусами при обнаружении расхождений.
- Поддержка тестового режима с указанным номером заказа и пользовательским диапазоном дат.
- Логирование операций в консоль и сохранение данных заказов в JSON-файлы (`abcp_orders.json`, `versta_orders.json`).
- Непрерывная работа с интервалом в 3 минуты между запусками.

## Требования

- Python 3.6 или выше.
- Необходимые Python-библиотеки:
  - `requests`
  - `python-dotenv`
- Переменные окружения (указываются в файле `.env`):
  - `ABCP_BASE_URL`: URL для получения заказов ABCP.
  - `ABCP_ORDER_UPDATE_URL`: URL для обновления статусов заказов ABCP.
  - `VERSTA_API_URL`: URL для получения заказов Versta24.
  - `ABCP_USER`: Имя пользователя для API ABCP.
  - `ABCP_PSW`: Пароль для API ABCP.
  - `VERSTA_TOKEN`: Токен для API Versta24.

## Установка

1. Склонируйте или загрузите скрипт на свой компьютер.
2. Установите необходимые библиотеки:

   ```bash
   pip install requests python-dotenv
   ```

3. Создайте файл `.env` в той же директории, где находится скрипт, и добавьте необходимые переменные окружения:

   ```env
   ABCP_BASE_URL=https://example.com/abcp/orders
   ABCP_ORDER_UPDATE_URL=https://example.com/abcp/update
   VERSTA_API_URL=https://api.versta24.com/orders
   ABCP_USER=your_abcp_username
   ABCP_PSW=your_abcp_password
   VERSTA_TOKEN=your_versta_token
   ```

## Использование

1. Запустите скрипт:

   ```bash
   python sync_orders.py
   ```

2. Скрипт работает в бесконечном цикле, проверяя обновления каждые 3 минуты.
3. Для работы в тестовом режиме (для конкретного заказа и диапазона дат) измените следующие переменные в скрипте:

   ```python
   TEST_MODE = True
   TEST_ORDER_NUMBER = 205699637
   CUSTOM_START_DATE = "2025-03-01 00:00:00"
   CUSTOM_END_DATE = "2025-03-10 23:59:59"
   ```

4. Логи выводятся в консоль, а данные заказов сохраняются в файлы `abcp_orders.json` и `versta_orders.json`.

## Сопоставление статусов

Скрипт использует комбинацию `masterStatus` и `subStatus` из Versta24 для точного сопоставления со статусами ABCP. Ниже приведена таблица соответствий:

| Versta24 `masterStatus` | Versta24 `subStatus`           | ABCP Status ID | ABCP Status Name         |
|-------------------------|--------------------------------|----------------|--------------------------|
| 100                     | 6 (CourierAssigned)            | 405204          | Доставляется             |
| 100                     | 7 (ParcelPickedUp)             | 405204          | Доставляется             |
| 100                     | 8 (CourierOnTheWay)            | 405204          | Доставляется             |
| 100                     | 9 (ParcelOnTheWay)             | 405204          | Доставляется             |
| 100                     | 10 (ParcelInTheRecipientCity)  | 405204          | Доставляется             |
| 100                     | 11 (ParcelHandedForDelivery)   | 405204          | Доставляется             |
| 200                     | 12 (ParcelInPickupPoint)       | 405205          | Доставлен                |
| 700                     | 90 (Finished)                  | 385106          | Получен                  |
| 800                     | 95 (RefuseOfDelivery)          | 385107          | Возвращается             |
| "ProblemDetected"       | (Любой)                        | 409382          | Проблема доставки        |
| "Returning"             | (Любой)                        | 384501          | Отменен поставщиком      |
| "Cancelled"             | (Любой)                        | 404714          | Отменен по неоплате      |
| "NotDelivered"          | (Любой)                        | 418655          | Вернулся в ТК            |
| "ReturnAccepted"        | (Любой)                        | 418656          | Возврат принят           |

## Логирование

- Логи форматируются в виде: `ГГГГ-ММ-ДД ЧЧ:ММ:СС [УРОВЕНЬ] СООБЩЕНИЕ`
- Уровни: `INFO`, `WARNING`, `ERROR`
- Логи отражают процесс получения, сопоставления и обновления заказов, а также любые ошибки, включая некорректные `subStatus` значения.

## Выходные файлы

- `abcp_orders.json`: Сохранённые заказы из ABCP.
- `versta_orders.json`: Сохранённые заказы из Versta24.

## Примечания

- Скрипт пропускает обновление позиций с нулевым количеством, нулевой суммой или статусом "Отменен поставщиком".
- При обнаружении неизвестного `masterStatus` или `subStatus` выводится предупреждение, и заказ пропускается.
- Скрипт обрабатывает ошибки API и продолжает работу после логирования проблемы.
- В тестовом режиме обрабатывается только указанный `TEST_ORDER_NUMBER` с пользовательским диапазоном дат.
- Если заказ не найден в списке ABCP для обновления, выводится предупреждение.

## Устранение неполадок

- **Ошибки API**: Проверьте правильность URL и учетных данных в файле `.env`.
- **Отсутствие заказов**: Убедитесь, что диапазон дат корректен и API доступен.
- **Несоответствие статусов**: Проверьте, что сопоставление `VERSTA_TO_ABCP` соответствует конфигурации ABCP и Versta24, включая точные названия `masterStatusName`.
- **Некорректный `subStatus`**: Убедитесь, что Versta24 API возвращает `statusCode` или `subStatus` в числовом формате.
